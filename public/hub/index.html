<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>gravity | density hub</title>
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


  <link rel="stylesheet" href="/styles/main.css">

  <link href="http://fonts.googleapis.com/css?family=Vollkorn" rel="stylesheet" type="text/css">

  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="/js/Tone.js"></script>
  <script type="text/javascript" src="/js/nexusUI.js"></script>
  <script type="text/javascript" src="/js/GravSound.js"></script>
  <script type="text/javascript" src="/js/browserHub.js"></script>
  <script type="text/javascript" src="/js/StartAudioContext.js"></script>
  <script src="/js/wavesurfer.min.js"></script>
  <script src="/js/wavesurfer.regions.min.js"></script>

</head>

<body>
  <div class="display">

    <h1"><span class="mainTitle">Gravity | Density</span></h1>

      <div class="nexusOverlay">
        <p>Example | <strong>Testing</strong></p>
        <p>Start by tapping your approximate location in the space.</p>
        <svg version="1.1" id="preMap" x="0px" y="0px" viewbox="0 0 640 445"
          style="max-width: 70vh; enable-background:new 0 0 640 445;">
          <rect x="4" y="4" style="fill:none;stroke:#B3B3B3;stroke-width:8;stroke-miterlimit:10;" width="632"
            height="437" />
          <rect x="77.5" y="70" style="fill:none;stroke:#4D4D4D;stroke-width:8;stroke-miterlimit:10;" width="485.1"
            height="350" />
          <line style="fill:none;stroke:#4D4D4D;stroke-width:18;stroke-miterlimit:10;" x1="30" y1="40" x2="610"
            y2="40" />
        </svg>
      </div>

      <div class="mainDisplay">
        <p>
          <br>
          <br><em>Thanks for tapping!<br>
            Have more users connect.<br>
            Tap the title above to test your audio.</em>
          <br>
          <div id="map">
            <svg version="1.1" id="seatMap" x="0px" y="0px" viewbox="0 0 640 445"
              style="max-width: 70vh; enable-background:new 0 0 640 445;">
              <rect x="4" y="4" style="fill:none;stroke:#B3B3B3;stroke-width:8;stroke-miterlimit:10;" width="632"
                height="437" />
              <rect x="77.5" y="70" style="fill:none;stroke:#4D4D4D;stroke-width:8;stroke-miterlimit:10;" width="485.1"
                height="350" />
              <line style="fill:none;stroke:#4D4D4D;stroke-width:18;stroke-miterlimit:10;" x1="30" y1="40" x2="610"
                y2="40" />
            </svg>
          </div>
          <div id="slider"></div>
          <div id="loadLaunch"></div>Load Launch <div id="triggerLaunch"></div>Trigger Launch
          <div id="enableRecord"></div>Enable Record
          <div id="enableTouch"></div>Enable Touch
          <div id="enableLoop"></div>Enable Loop
          <br>
          <!-- <div id="waveform"></div>
          <br><audio controls></audio> -->
          <div id="samples">
            <!-- <div id="player-1">
              <div id="record-1"></div>
              <div id="play-1"></div>
              <div id="loopBegin-1"></div>
              <div id="loopEnd-1"></div>
            </div> -->
          </div>

          <br><br>
          <button onClick="tapEnd()">Tap To End Session</button>
        </p>

      </div>

  </div>

  <div id="typed-text">...</div>

  <div class="endDisplay" style="display: none;">
    <p>
      <br>
      <br><em>Nice Set<br>
        Please visit <a href="http://gravity.emdm.io">gravity.emdm.io</a> for documentation.</em>
    </p>
  </div>

  <script>
    var Hub = require('hub');
    var hub = new Hub();
    hub.init();

    hub.user.name = "gravityHub";
    hub.user.color = getRandomColor();
    hub.user.location = {
      x: 0.5,
      y: 0.5
    }

    // let playerSampleCount = 0;
    // let sampleLength = 5000;

    // *** Nexus UI Elements ***

    let record = [];
    let play = [];
    let loopBegin = [];
    let loopEnd = [];
    let clear = [];

    let loadLaunch = new Nexus.Button("#loadLaunch");
    let triggerLaunch = new Nexus.Button("#triggerLaunch");
    let enableRecord = new Nexus.Toggle('#enableRecord');
    let enableTouch = new Nexus.Toggle('#enableTouch');
    let enableLoop = new Nexus.Toggle('#enableLoop');

    // let record_1 = new Nexus.Toggle("#record-1");
    // let play_1 = new Nexus.Toggle("#play-1");
    // let loopBegin_1 = new Nexus.Number("#loopBegin-1");
    // let loopEnd_1 = new Nexus.Number("#loopEnd-1");

    // record_1.on('change', function (v) {
    //   v ? gravSound.recorder.start() : gravSound.recorder.stop();
    // });

    enableRecord.on ('change', (v) => {
      let data = {};
      data.user = "all";
      data.val = "record";
      data.enabled = v;
      console.log(data)
      hub.transmit('enable', null, data);
    });

    enableTouch.on ('change', (v) => {
      let data = {};
      data.user = "all";
      data.val = "touch";
      data.enabled = v;
      console.log(data)
      hub.transmit('enable', null, data);
    });

    enableLoop.on ('change', (v) => {
      let data = {};
      data.user = "all";
      data.val = "loop";
      data.enabled = v;
      console.log(data)
      hub.transmit('enable', null, data);
    });


        // -------- LAUNCH CONTROLS
    loadLaunch.on('change', function (v) {
      if(v.state==false) {
        loadFile('/data/mp3s/AtlasVLaunch.mp3');
      }
    });

    triggerLaunch.on('change', function (v) {
      if(v.state==true) {
        let data = {
          user : 'all',
          val : 'play'
        }
        hub.transmit('sample',null, data);
      }
    });


    // Shared slider... possibly a good volume control?
    let slider = new Nexus.Slider('#slider', {
      'mode': 'absolute'
    });
    hub.channel('sharedSlider', null, null, function (data) {
      slider.value = data.val;
    });
    slider.on('change', function (v) {
      // do not send along if not changed from a user interaction.
      if (slider.clicked) {
        hub.send('sharedSlider', {
          val: v
        });
      };
    });

    // ****** Player Communications ****** //

    var secNum = 0;

    document.getElementsByTagName('body')[0].style.borderLeft = "15px solid" + hub.user.color;

    preMap.addEventListener('click', getClickPosition, false);
    StartAudioContext(Tone.context, '#preMap').then(function () {
      console.log("AudioStarted");
    })

    function getClickPosition(e) {
      var m = preMap.getScreenCTM();
      var p = document.getElementById('preMap').createSVGPoint();
      p.x = e.clientX;
      p.y = e.clientY;
      p = p.matrixTransform(m.inverse());
      var tx = document.getElementById('preMap').getAttribute('viewBox').split("")[2];
      var ty = document.getElementById('preMap').getAttribute('viewBox').split("")[3];
      var mx = p.x / tx;
      var my = p.y / ty;

      hub.user.location.x = mx;
      hub.user.location.y = my;
      console.log(hub.user.location);

      gravSound.triggerPitch();
      hub.register();
      // FIXME: move default overlay into Hub
      document.getElementsByClassName("nexusOverlay")[0].style.display = 'none';
      document.getElementsByClassName("mainDisplay")[0].style.display = 'block';
      // wavesurfer.load('data/mbira_em.mp3');
    }

    hub.channel('setSection', null, null, function (data) {
      console.log(data);
      console.log("the section is now:" + data.title);

      secNum = data.sect;

    });

    hub.channel('tap', null, null, function (data) {
      hub.log(`tap received: $ { data }`);
    })

    function tapButton() {
      hub.send('tap', {
        'tap': 1
      });
    }

    hub.channel('itemback', null, 'about', function (data) {
      console.log("itemback:", data);
    });


    function tapEnd() {
      document.getElementsByClassName("mainDisplay")[0].style.display = 'none';
      document.getElementsByClassName("endDisplay")[0].style.display = 'block';
    }


    function getRandomColor() {
      var letters = '0123456789ABCDEF'.split('');
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }


    hub.channel('sample', null, null, (data) => {
      // data.user = "name", .val = "capture", .duration = "5"
      console.log("User? ", gravSound.userSamples[data.user]);

      if (gravSound.userSamples[data.user] == null) {
        if (data.val == "capture") {
          gravSound.createSample(data.user, gravSound.sampleLength);
        }
        console.log(`${data.user} recording a sample of ${gravSound.sampleLength} seconds`);
      }

      if (data.val == "loop") {
        if (data.loopBegin >= 0.) {
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].start = data.loopBegin *
            gravSound.sampleLength;
        }
        if (data.loopEnd <= 1.0) {
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].end = data.loopEnd * gravSound.sampleLength;
        }
        gravSound.wavesurfers[gravSound.userSamples[data.user].id].drawBuffer()
        if(data.play) {
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].loop = true;
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].playLoop();
        }
        console.log(`${data.user} set loop to ${data.loopBegin} – ${data.loopEnd}`);
      }

      if(data.user == "all") {
        // Probably shouldn't play if all is triggered.
      } else {
        if(data.val == "play") {
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].loop = false;
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].play();
        }
        if(data.val == "playLoop") {
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].loop = true;
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].playLoop();
        }
      }
    });

    function loadFile(file) {
      let data = {
        user : 'all',
        val : 'load',
        url : file
      }
      hub.transmit('sample', null, data);
    }

    hub.channel('loop', null, null, (data) => {
      // data.user = "name", .loopBegin = 0., .loopEnd = 1.0
      if (data.loopBegin >= 0.) {
        gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].start = data.loopBegin *
          gravSound.sampleLength;
      }
      if (data.loopEnd <= 1.0) {
        gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].end = data.loopEnd * gravSound
          .sampleLength;
      }

      console.log(`${data.user} set loop to ${data.loopBegin} – ${data.loopEnd}`);
    });


    // var GravSound = function () {

    //   this.tone = new Tone();

    //   this.wavesurfers = [];
    //   this.audio = [];

    //   // Audio Input
    //   var liveFeed = new Tone.UserMedia();
    //   Tone.UserMedia.enumerateDevices().then(function (devices) {
    //     console.log(devices)
    //   })
    //   liveFeed.open().then(function () {
    //     //promise resolves when input is available
    //   });

    //   this.audio[0] = document.querySelector('audio');
    //   this.dest = this.tone.context.createMediaStreamDestination();
    //   this.recorder = new MediaRecorder(this.dest.stream);

    //   liveFeed.connect(this.dest);

    //   this.chunks = [];

    //   this.recorder.ondataavailable = evt => {
    //     // chunks.push(evt.data);
    //     for (let i = 0; i < playerSampleCount; i++) {
    //       if (this.chunks[i].recording === true) {
    //         this.chunks[i].chunks.push(evt.data);
    //       }
    //     }
    //   };

    //   this.recorder.onstop = evt => {
    //     let soundBlob = new Blob(this.chunks[this.recorder.userNumber].chunks, {
    //       type: 'audio/ogg; codecs=opus'
    //     });
    //     this.chunks[this.recorder.userNumber].recording = false;
    //     for (let i = 0; i < playerSampleCount; i++) {
    //       if (this.chunks[i].recording === true && this.recorder.state === "inactive") {
    //         this.recorder.start();
    //       }
    //     }
    //     console.log('recording stopped');
    //     this.audio[this.recorder.userNumber].src = URL.createObjectURL(soundBlob);
    //     this.wavesurfers[this.recorder.userNumber].loadBlob(soundBlob);
    //     console.log('recording Loaded');
    //     this.sendSample(this.recorder.user, this.recorder.userNumber, soundBlob)
    //   };


    //   this.createSample = function (user, sampleLength) {

    //     // var url = URL.createObjectURL(blob);
    //     let sampleDiv = document.getElementById("samples");
    //     let newDiv = document.createElement("div");
    //     newDiv.setAttribute("id", "sample-" + playerSampleCount);
    //     let au = document.createElement('audio');
    //     let ws = document.createElement('div');
    //     ws.setAttribute("id", "waveform-" + playerSampleCount);
    //     au.setAttribute("id", 'audio-' + playerSampleCount);
    //     au.controls = 'controls';
    //     newDiv.appendChild(ws);
    //     newDiv.appendChild(au);
    //     sampleDiv.appendChild(newDiv);

    //     this.chunks[playerSampleCount] = {
    //       recording: true,
    //       chunks: []
    //     };
    //     this.audio[playerSampleCount] = document.getElementById("audio-" + playerSampleCount);
    //     this.wavesurfers[playerSampleCount] = WaveSurfer.create({
    //       container: '#waveform-' + playerSampleCount,
    //       waveColor: 'violet',
    //       progressColor: 'purple',
    //       plugins: [
    //         WaveSurfer.regions.create({})
    //       ]
    //     });

    //     this.wavesurfers[playerSampleCount].on('ready', (playerSampleCount) => {
    //       this.wavesurfers[playerSampleCount].addRegion({
    //         id: 1,
    //         start: 1,
    //         end: 3,
    //         drag: true,
    //         loop: true,
    //         color: 'hsla(100, 100%, 30%, 0.5)'
    //       });
    //       this.wavesurfers[playerSampleCount].regions.list[1].on('update', (playerSampleCount) => {
    //         this.wavesurfers[playerSampleCount].regions.list[1].play();
    //         this.wavesurfers[playerSampleCount].regions.list[1].un('update');
    //       });
    //     });

    //     // var li = document.createElement('li');
    //     // var link = document.createElement('a');
    //     // //add controls to the <audio> element 
    //     // au.controls = true;
    //     // au.src = url;
    //     // //link the a element to the blob 
    //     // link.href = url;
    //     // link.download = new Date().toISOString() + '.wav';
    //     // link.innerHTML = link.download;
    //     // //add the new audio and a elements to the li element 
    //     // li.appendChild(au);
    //     // li.appendChild(link);
    //     // //add the li element to the ordered list 
    //     // recordingsList.appendChild(li);
    //     if (this.recorder.state === "inactive") {
    //       this.recorder.start();
    //     }
    //     // Passing the current playerSampleCount in as this.recorder.userNumber so that it remains the correct number is multiple records happen.
    //     let recordingTimer = setTimeout(
    //       (user, userNumber) => { // setup a timeout for the recording, after the time below expires, do the tings inside the {}
    //         this.recorder.user = user;
    //         this.recorder.userNumber = userNumber;
    //         console.log(user);
    //         this.recorder.stop(); // stop recording
    //       }, sampleLength, user, playerSampleCount) //record for sample length (in ms)

    //     playerSampleCount += 1;
    //   }


    //   this.sendSample = function (user, userNumber, soundBlob) {
    //     let formdata = new FormData(); //create a from to of data to upload to the server
    //     formdata.append('soundBlob', soundBlob,
    //       this.recorder.user + 'Sample.ogg'
    //     ); // append the sound blob and the name of the file. third argument will show up on the server as req.file.originalname

    //     // Now we can send the blob to a server...
    //     let serverUrl = '/upload'; //we've made a POST endpoint on the server at /upload
    //     let httpRequestOptions = { //build a HTTP POST request
    //       method: 'POST',
    //       body: formdata, // with our form data packaged above
    //       headers: new Headers({
    //         'enctype': 'multipart/form-data' // the enctype is important to work with multer on the server
    //       })
    //     };
    //     fetch(serverUrl, httpRequestOptions).then(res => {
    //       console.log(res)
    //     }).then(error => {
    //       console.log(error)
    //     });

    //     console.log('recording sent');
    //   }


    //   // Effects and Synths

    //   this.tremolo = new Tone.Tremolo({
    //     "frequency": 8,
    //     "type": "sine",
    //     "depth": 0.6,
    //     "spread": 0
    //     //"wet": 0.8
    //   }).toMaster().start();

    //   this.synth = new Tone.Synth({
    //     "oscillator": {
    //       "type": "sine"
    //     },
    //     "envelope": {
    //       "attack": 2.0,
    //       "decay": 0.5,
    //       "sustain": 0.8,
    //       "release": 2.0
    //     }
    //   }).connect(this.tremolo);

    //   this.synth.volume.value = -10;

    //   // Players

    //   this.player = [];
    //   this.player[0] = new Tone.Player("data/mp3s/CD_Track_2.mp3").toMaster();
    //   this.player[1] = new Tone.Player("data/mp3s/Collide.mp3").toMaster();

    //   Tone.Transport.start();

    //   this.pitchCollection = [55, 57, 59, 61, 62, 64, 66, 67, 68, 69, 71, 73, 75, 76, 78, 80, 82, 83];

    //   this.pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
    //   console.log("Pitch & Length:", this.pitch, this.pitchCollection.length);

    //   this.freq = function (midi) {
    //     var note = Tone.Frequency(midi).toFrequency();
    //     // console.log("Midi:", midi, note)
    //     return note;
    //   };

    //   // **** Playing Notes **** //
    //   this.playPitch = function (pitch) {
    //     if (pitch) {
    //       this.synth.triggerAttackRelease(this.freq(pitch), 0.5);
    //     } else {
    //       this.synth.triggerAttackRelease(this.freq(this.pitch), 5);

    //     }
    //   };

    //   this.playRandomPitch = function () {
    //     var pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
    //     this.synth.triggerAttackRelease(this.freq(pitch), 0.5);
    //   };

    //   this.triggerPitch = function () {
    //     this.synth.triggerAttackRelease(this.freq(this.pitch), 5);
    //     hub.send('triggerPitch', {
    //       'pitch': this.pitch
    //     });
    //   };

    //   this.playFirstSound = function () {
    //     this.player[0].start();
    //   };

    //   this.triggerFirstSound = function () {
    //     this.playPitch();
    //     this.player[0].start();
    //     // this.seqRandomize();
    //     hub.send('triggerFirstSound', {
    //       'pitch': this.pitch
    //     });

    //     var elements = document.getElementsByClassName("mainTitle");
    //     // elements[0].className +=" clicked";
    //     elements[0].style.backgroundColor = hub.user.color;
    //   };

    //   // ****  Events ****

    //   this.playSecondSound = function () {
    //     this.player[1].start();
    //     // var pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
    //     // this.synth.triggerAttackRelease(this.freq(pitch), 5);
    //     this.playRandomPitch();
    //   };

    // };

    var gravSound = new GravSound();
    hub.user.pitch = gravSound.pitch;

    // var wavesurfer = WaveSurfer.create({
    //   container: '#waveform',
    //   waveColor: 'violet',
    //   progressColor: 'purple',
    //   plugins: [
    //     WaveSurfer.regions.create({
    //       // regions: [{
    //       //         id: 1,
    //       //         start: 1,
    //       //         end: 3,
    //       //         drag: true,
    //       //         color: 'hsla(400, 100%, 30%, 0.5)'
    //       //     }]
    //       // dragSelection: {
    //       //     slop: 5
    //       // }
    //     })
    //   ]
    // });

    // // wavesurfer.enableDragSelection({
    // //     id: 1,
    // //     loop: true
    // // });

    // wavesurfer.on('ready', function () {
    //   // wavesurfer.play();
    //   wavesurfer.addRegion({
    //     id: 1,
    //     start: 1,
    //     end: 3,
    //     drag: true,
    //     loop: true,
    //     color: 'hsla(100, 100%, 30%, 0.5)'
    //   });
    //   wavesurfer.regions.list[1].on('update', function () {
    //     wavesurfer.regions.list[1].play();
    //     wavesurfer.regions.list[1].un('update');
    //   });
    // });

  </script>

</body>

</html>